---
alwaysApply: true
---

# üöÄ **MohallaMart: A Modern, Local Shop E‚ÄëCommerce Ecosystem**

A fully modernized, more interactive, more readable version of your project specification.

---

## üåç **Project Overview**

MohallaMart bridges the gap between local commerce and digital convenience through a **multi‚Äëtenant**, **realtime**, **mobile‚Äëfirst** shopping experience.

Built with **Next.js 15**, **TypeScript**, **Convex realtime backend**, and a refined **design system**, MohallaMart empowers neighborhood shops to operate digitally with seamless delivery, payment, and user engagement capabilities.

---

## üß∞ **Tech Stack at a Glance**

### üé® **Frontend**

* **Next.js 15.5.3** (App Router + React Server Components)
* **TypeScript** (strict mode)
* **Tailwind CSS 4** with global CSS variables
* **Shadcn UI + Radix Primitives** (MANDATORY - use maximally, install if not available)
* **Zustand** for global state (with persistence)
* **Framer Motion** (strategic use only)
* **Lucide Icons**
* **Fonts**: Open Sans (body) + Montserrat (headings)

### ‚öôÔ∏è **Backend & Database**

* **Convex** (realtime backend + mutations/queries)
* **tRPC** (end‚Äëto‚Äëend type‚Äësafe APIs)
* **Supabase PostgreSQL** (primary database)
* **Redis** (caching layer)
* **Supabase Auth** (OTP login)

### üîå **External Integrations**

* **Razorpay** (payments)
* **Leaflet + OpenStreetMap** (location + geocoding via Nominatim)
* **Typesense** (super‚Äëfast search)
* **OneSignal** (push notifications)
* **Twilio/MSG91** (SMS)
* **Convex File Storage** (images/files)
* **Inngest** (jobs & automation)

---

## üóÇÔ∏è **Project Structure**

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx (Login/Signup page)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ callback/ (Supabase auth callback)
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/ (Admin API routes)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ debug/ (Debug endpoints)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inngest/ (Inngest webhook)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shopkeeper/ (Shopkeeper API routes)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trpc/ (tRPC endpoint)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vendors/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ nearby/ (GET endpoint for nearby vendors with ETA)
‚îÇ   ‚îú‚îÄ‚îÄ shopkeeper/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _components/ (ShopkeeperGuard, ShopkeeperHeader, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/ (Dashboard with stats and actions)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile/ (Shopkeeper profile management)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/ (Product management)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shop/ (Shop creation and management)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apply/ (Shopkeeper application)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ registration/ (Registration status)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/ (Shopkeeper login)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signup/ (Shopkeeper signup)
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _components/ (AdminHeader, AdminSidebar, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (protected)/ (Protected admin routes)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ registrations/ (Registration management)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users/ (User management)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login/ (Admin login)
‚îÇ   ‚îú‚îÄ‚îÄ shops/ (Shop listing page)
‚îÇ   ‚îú‚îÄ‚îÄ shop/[slug]/ (Individual shop page)
‚îÇ   ‚îú‚îÄ‚îÄ pd/[id]/[slug]/ (Product detail page)
‚îÇ   ‚îú‚îÄ‚îÄ profile/ (User profile page)
‚îÇ   ‚îú‚îÄ‚îÄ features/ (Feature status page)
‚îÇ   ‚îú‚îÄ‚îÄ globals.css (Theme variables and global styles)
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx (Root layout)
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx (Home page)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginForm.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignupForm.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shopkeeper/ (Shopkeeper auth forms)
‚îÇ   ‚îú‚îÄ‚îÄ sections/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HeroSection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NearbyStoresSection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TopRatedProductsSection.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CoreInfoSection.tsx
‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCard.tsx (with ETA support)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ShopCard.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RelatedProductsRow.tsx
‚îÇ   ‚îú‚îÄ‚îÄ cart/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartSidebar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ui/ (Shadcn UI components)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (other Shadcn components)
‚îÇ   ‚îú‚îÄ‚îÄ Navbar.tsx (Desktop navigation)
‚îÇ   ‚îú‚îÄ‚îÄ MobileHeader.tsx (Mobile header with dynamic ETA)
‚îÇ   ‚îú‚îÄ‚îÄ MobileBottomNav.tsx (Mobile bottom navigation)
‚îÇ   ‚îú‚îÄ‚îÄ SearchBar.tsx
‚îÇ   ‚îú‚îÄ‚îÄ LocationModal.tsx (Location picker with Leaflet)
‚îÇ   ‚îú‚îÄ‚îÄ MapView.tsx (Leaflet map component)
‚îÇ   ‚îú‚îÄ‚îÄ ImageModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ImageUpload.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ToastProvider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ConvexProvider.tsx
‚îÇ   ‚îú‚îÄ‚îÄ TRPCProvider.tsx
‚îÇ   ‚îî‚îÄ‚îÄ InngestProvider.tsx
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts
‚îÇ   ‚îú‚îÄ‚îÄ useToast.ts
‚îÇ   ‚îú‚îÄ‚îÄ useConvex.ts
‚îÇ   ‚îî‚îÄ‚îÄ use-mobile.ts
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts (Supabase client)
‚îÇ   ‚îú‚îÄ‚îÄ convex.ts (Convex client)
‚îÇ   ‚îú‚îÄ‚îÄ trpc.ts (tRPC client)
‚îÇ   ‚îú‚îÄ‚îÄ typesense.ts (Typesense search)
‚îÇ   ‚îú‚îÄ‚îÄ redis.ts (Redis client)
‚îÇ   ‚îú‚îÄ‚îÄ razorpay.ts (Payment integration)
‚îÇ   ‚îú‚îÄ‚îÄ adminAuth.ts (Admin authentication)
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts (Utility functions)
‚îÇ   ‚îú‚îÄ‚îÄ images.ts (Image path management)
‚îÇ   ‚îú‚îÄ‚îÄ retry.ts (Retry logic)
‚îÇ   ‚îú‚îÄ‚îÄ distance.ts (Haversine distance calculation)
‚îÇ   ‚îú‚îÄ‚îÄ eta.ts (ETA calculation system)
‚îÇ   ‚îú‚îÄ‚îÄ vendor-geo.ts (Vendor geographic utilities)
‚îÇ   ‚îú‚îÄ‚îÄ time.ts (Peak hour detection)
‚îÇ   ‚îú‚îÄ‚îÄ data/ (Data sync utilities)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ examples.ts
‚îÇ   ‚îî‚îÄ‚îÄ inngest/ (Background jobs)
‚îÇ       ‚îú‚îÄ‚îÄ events.ts
‚îÇ       ‚îú‚îÄ‚îÄ functions.ts
‚îÇ       ‚îî‚îÄ‚îÄ serve.ts
‚îú‚îÄ‚îÄ convex/ (Convex backend functions)
‚îÇ   ‚îú‚îÄ‚îÄ users.ts
‚îÇ   ‚îú‚îÄ‚îÄ shops.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.ts
‚îÇ   ‚îú‚îÄ‚îÄ orders.ts
‚îÇ   ‚îú‚îÄ‚îÄ categories.ts
‚îÇ   ‚îî‚îÄ‚îÄ schema.ts
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îî‚îÄ‚îÄ trpc.ts (tRPC server setup)
‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îî‚îÄ‚îÄ useStore.ts (Zustand global store)
‚îî‚îÄ‚îÄ theme/
    ‚îú‚îÄ‚îÄ config.ts
    ‚îî‚îÄ‚îÄ types.ts
```

---

## üéØ **Shadcn UI Component Workflow (MANDATORY)**

### üìã **Before Creating Any UI Component**

1. **‚ö†Ô∏è CRITICAL: Read `src/app/globals.css` FIRST** - Understand available CSS variables, theme system, and color definitions before making any changes
2. **Check if Shadcn UI component exists** in `src/components/ui/` directory
3. **If component exists**, use it immediately
4. **If component doesn't exist**, install it using: `npx shadcn@latest add [component-name] --yes`
5. **Never create custom UI components** that duplicate Shadcn UI functionality
6. **Always prefer Shadcn UI components** over custom implementations
7. **Always implement dark/light theme support** (except for admin pages) using CSS variables from `globals.css`
8. **Never hardcode colors** - Use theme-aware classes or CSS variables from `globals.css`

### üì¶ **Common Shadcn UI Components Available**

* Form Components: `Button`, `Input`, `Label`, `Select`, `Checkbox`, `RadioGroup`, `Switch`, `Textarea`
* Layout Components: `Card`, `Separator`, `Sheet`, `Sidebar`, `Tabs`, `Accordion`
* Overlay Components: `Dialog`, `AlertDialog`, `DropdownMenu`, `Popover`, `Tooltip`, `HoverCard`
* Feedback Components: `Toast` (via `sonner`), `Alert`, `Skeleton`, `Progress`, `Badge`
* Data Display: `Table`, `Avatar`, `Calendar`, `Command`

### üîÑ **Installation Command**

```bash
npx shadcn@latest add [component-name] --yes
```

### ‚úèÔ∏è **Customization**

* Customize Shadcn components by modifying `src/components/ui/[component].tsx` files
* Maintain consistent styling across all Shadcn components
* Use Tailwind CSS classes and CSS variables from `globals.css`
* Follow the design system colors and spacing

---

## üîî **Toast Notifications (MANDATORY)**

### üìã **Using Toast for User Feedback**

**ALWAYS use toast notifications** for user feedback instead of browser alerts or console logs. Toast notifications provide a better user experience and are accessible.

### üéØ **Import and Usage**

```typescript
import { useToast } from "@/hooks/useToast";

// In your component
const { success, error, warning, info } = useToast();

// Usage examples
success("Operation completed successfully");
error("Something went wrong");
warning("Please check your input");
info("Processing your request...");
```

### üì¶ **Toast Types**

* **`success()`**: Use for successful operations (e.g., "Logged in successfully", "Order placed")
* **`error()`**: Use for errors and failures (e.g., "Login failed", "Network error")
* **`warning()`**: Use for warnings and cautions (e.g., "Please check your input", "Low stock")
* **`info()`**: Use for informational messages (e.g., "Loading...", "Theme changed")

### ‚úÖ **Best Practices**

1. **Always use toast for user feedback** - Never use `alert()`, `confirm()`, or `console.log()` for user notifications
2. **Use appropriate toast types** - Match the toast type to the message severity
3. **Keep messages concise** - Toast messages should be short and clear
4. **Use toast for actions** - Show toast notifications after user actions (login, logout, form submission, etc.)
5. **Provide context** - Include relevant information in the toast message (e.g., "Order #1234 placed successfully")

### üö´ **When NOT to Use Toast**

* **Critical errors that require immediate attention** - Use error boundaries or dedicated error pages
* **Form validation errors** - Use inline error messages next to form fields
* **Debugging** - Use console.log for development debugging only
* **Confirmation dialogs** - Use Shadcn `AlertDialog` component instead

### üìù **Examples**

```typescript
// ‚úÖ Good: Success toast after login
const handleLogin = async () => {
  await login();
  success("Logged in successfully");
};

// ‚úÖ Good: Error toast for failed operations
const handleSubmit = async () => {
  try {
    await submitForm();
    success("Form submitted successfully");
  } catch (error) {
    error("Failed to submit form. Please try again.");
  }
};

// ‚úÖ Good: Info toast for theme changes
const handleThemeToggle = () => {
  toggleTheme();
  info(isDark ? "Dark mode enabled" : "Light mode enabled");
};

// ‚ùå Bad: Using alert
alert("Operation completed"); // Don't use this

// ‚ùå Bad: Using console.log for user feedback
console.log("User logged in"); // Don't use this
```

### üîß **Toast Configuration**

* Toast notifications are provided by Shadcn's `sonner` component
* Toast duration can be customized: `success("Message", 5000)` // 5 seconds
* Default duration is 4000ms (4 seconds)
* Toast provider is configured in `src/components/ToastProvider.tsx`

---

## üíª **Coding Standards**

### üî∑ TypeScript

* Strict mode always enabled
* Use `interface` for object shapes
* Use `type` for unions/primitives
* Always type component props + return values
* Type‚Äësafe custom hooks

### üî∑ React Best Practices

* Functional components only
* Client components only when needed (`"use client"`)
* Clean separation of server/client logic
* Memoization for heavy components
* Proper loading, error, and empty states
* **ALWAYS use Shadcn UI components** for UI elements
* **ALWAYS implement dark/light theme support** for all non-admin components using CSS variables from `globals.css`
* Test components in both light and dark themes before submitting

---

## üé® **Styling & Design System**

### ‚ö†Ô∏è **CRITICAL: UI Change Workflow (MANDATORY)**

**BEFORE making ANY UI changes, you MUST:**

1. **ALWAYS read `src/app/globals.css` FIRST** - This file contains all theme variables, color definitions, and design system tokens
2. **Understand the available CSS variables** - Check what variables are defined for:
   - Colors (`--primary`, `--secondary`, `--background`, `--foreground`, `--card`, `--border`, etc.)
   - Semantic colors (`--success-bg-light`, `--success-fg`, `--warning-bg-light`, `--warning-fg`, etc.)
   - Theme-specific values (light mode vs dark mode)
3. **Apply changes according to dark/light theme** - Ensure all UI changes work in both themes
4. **Use CSS variables from `globals.css`** - Never hardcode colors or use arbitrary values
5. **Test in both themes** - Verify the changes look correct in light and dark mode

**Workflow Example:**
```typescript
// Step 1: Read globals.css to understand available variables
// Step 2: Identify which CSS variables to use
// Step 3: Apply theme-aware classes
className="bg-white dark:bg-black text-black dark:text-white border-neutral-200 dark:border-neutral-800" // Standard pattern
className="bg-[var(--success-bg-light)] text-[var(--success-fg)]" // Direct variable usage for semantic colors
```

**‚ùå NEVER:**
- Make UI changes without reading `globals.css` first
- Hardcode colors like `bg-blue-500` or `text-black`
- Use arbitrary values without checking theme compatibility
- Skip dark mode implementation (except for admin pages)

**‚úÖ ALWAYS:**
- Read `globals.css` before any UI modification
- Use CSS variables from the design system
- Implement both light and dark theme support
- Reference the theme variables when making styling decisions

### Tailwind + CSS Variables

* All colors defined in `globals.css`
* Tailwind reads values from CSS properties
* **ALWAYS use CSS variables** from `globals.css` - never hardcode colors

### üåó **Dark & Light Theme Support (MANDATORY)**

**CRITICAL**: All pages and components (except admin pages) **MUST support both dark and light themes**.

* **Always implement both themes** - Use Tailwind's `dark:` variant for dark mode styles
* **Use CSS variables from `globals.css`** - Never use hardcoded colors
* **Test in both themes** - Ensure components look good in both light and dark mode
* **Admin pages are exempt** - Admin pages (`/admin/*`) do not need dark theme support
* **All other pages/components require dual theme support**

### üìã **Theme Implementation Rules**

1. **Always use theme-aware classes**:
   ```tsx
   // ‚úÖ Good: Theme-aware background
   className="bg-white dark:bg-black"
   
   // ‚úÖ Good: Theme-aware text
   className="text-black dark:text-white"
   
   // ‚úÖ Good: Theme-aware borders
   className="border-neutral-200 dark:border-neutral-800"
   
   // ‚ùå Bad: Hardcoded colors without dark mode
   className="bg-white text-black"
   ```

2. **Always test both themes** before submitting code

/* Removed legacy Background Color Scheme section in favor of token-based guidance */

### üìù **Text Color Guidelines (MANDATORY)**

**CRITICAL**: For user-facing text, **ALWAYS use theme-aware text colors** - never hardcode black text that applies to both light and dark modes.

#### ‚úÖ **Correct Text Color Usage**

* **Use black text for light mode, white text for dark mode**:
  ```tsx
  // ‚úÖ Good: Theme-aware text colors
  className="text-black dark:text-white"
  className="text-neutral-600 dark:text-neutral-300" // For secondary text
  ```

* **Use colorful text colors when needed** (for emphasis, branding, or semantic meaning):
  ```tsx
  // ‚úÖ Good: Colorful text for specific purposes
  className="text-primary" // Brand color
  className="text-secondary" // Accent color
  className="text-green-600 dark:text-green-400" // Success state
  className="text-red-600 dark:text-red-400" // Error state
  className="text-blue-600 dark:text-blue-400" // Info state
  ```


#### ‚ùå **Incorrect Text Color Usage**

* **NEVER hardcode black text that works in both themes**:
  ```tsx
  // ‚ùå Bad: Black text in both light and dark mode
  className="text-black" // Will be invisible or hard to read in dark mode
  className="text-neutral-900" // Without dark: variant, invisible in dark mode
  
  // ‚ùå Bad: Using CSS variables that are black in both modes
  className="text-[var(--some-black-variable)]" // If variable is black for both themes
  ```

* **NEVER use the same text color for both themes without proper contrast**:
  ```tsx
  // ‚ùå Bad: Same color for both themes
  className="text-gray-800" // No dark mode variant
  ```

#### üìã **Text Color Best Practices**

1. **Always provide dark mode variants** for text colors:
   ```tsx
   // ‚úÖ Good: Explicit theme variants
   className="text-black dark:text-white"
   className="text-neutral-600 dark:text-neutral-300" // For secondary text
   ```


3. **Use colorful text for semantic meaning**:
   ```tsx
   // ‚úÖ Good: Colorful text for specific purposes
   className="text-primary" // Brand/primary actions
   className="text-secondary" // Secondary actions
   className="text-green-600 dark:text-green-400" // Success messages
   className="text-red-600 dark:text-red-400" // Error messages
   ```

4. **Ensure proper contrast** - Text must be readable in both themes:
   ```tsx
   // ‚úÖ Good: High contrast in both themes
   className="text-black dark:text-white" // High contrast
   
   // ‚ùå Bad: Low contrast
   className="text-neutral-400 dark:text-neutral-500" // Hard to read
   ```

5. **Test text visibility** in both light and dark modes before submitting

#### üéØ **Common Text Color Patterns**

```tsx
// Primary text (headings, important content)
className="text-black dark:text-white"

// Secondary text (descriptions, captions)
className="text-neutral-600 dark:text-neutral-300"

// Brand/Accent text
className="text-primary"
className="text-secondary"

// Semantic text (success, error, warning, info)
className="text-green-600 dark:text-green-400" // Success
className="text-red-600 dark:text-red-400" // Error
className="text-yellow-600 dark:text-yellow-400" // Warning
className="text-blue-600 dark:text-blue-400" // Info
```

### üé® Color Scheme

* **Primary**: Forest Green `--color-primary` / `var(--primary)`
* **Secondary**: Vibrant Orange `--color-secondary` / `var(--secondary)`
* **Accent**: Sunny Yellow `--color-accent` / `var(--accent)`
* **Neutral**: Consistent grayscale scale (theme-aware)
* **Semantic colors**: Use CSS variables from `globals.css` for semantic colors (success, warning, error, info)

### Typography

* **Headings**: Montserrat (`--font-montserrat`)
* **Body**: Open Sans (`--font-open-sans`)

### UX Rules

* Mobile‚Äëfirst layout
* Generous spacing, readable typography
* **Dark theme support required** for all non-admin pages/components
* Modals (z‚Äë9999), Dropdowns (z‚Äë10000), Navbar (z‚Äë50)

---

## üß© **Component Principles**

* Reusable + composable components
* **Shadcn UI components MUST be used maximally** - always prefer Shadcn UI components over custom implementations
* If a Shadcn UI component is needed but not available, **install it first** using: `npx shadcn@latest add [component-name] --yes`
* **Dark & Light theme support MANDATORY** - All components (except admin) must support both themes using CSS variables from `globals.css`
* Use Radix primitives for accessibility
* Client/server split for performance
* Clear TypeScript types for props
* Guard components for route protection (e.g., `ShopkeeperGuard`)
* **Toast notifications via `useToast` hook** - Always use `useToast()` for user feedback, never use `alert()` or `confirm()`
* Toast provider configured in `ToastProvider.tsx` using Shadcn's `sonner` component

### üé® **Shadcn UI Component Guidelines**

* **ALWAYS use Shadcn UI components when available** - Check `src/components/ui/` directory first
* **If component doesn't exist**, install it immediately using: `npx shadcn@latest add [component-name] --yes`
* **Never create custom UI components** that duplicate Shadcn UI functionality
* **Common Shadcn UI components to use**:
  - `Button`, `Card`, `Input`, `Label`, `Select`, `Dialog`, `AlertDialog`
  - `DropdownMenu`, `Sheet`, `Tooltip`, `Badge`, `Separator`, `Skeleton`
  - `Toast` (via `sonner`), `Sidebar`, and others as needed
* **Customize Shadcn components** by modifying `src/components/ui/[component].tsx` files
* **Maintain consistency** by using the same Shadcn components across the entire application

---

## üîê **Authentication Flow**

* Supabase Auth OTP login (email/phone)
* Convex keeps realtime session sync
* Zustand stores user state (persistent)
* Automatic refresh token handling
* Secure server‚Äëside admin utilities separate from client

---

## üõí **State Management**

* Zustand global store (cart, search, location, user, toasts)
* LocalStorage persistence (cart + user)
* Convex sync for realtime backend updates
* Redis for caching frequent queries

---

## üìö **File Naming Conventions**

* Components: `PascalCase`
* Hooks: `useSomething`
* Libraries: camelCase
* Types: PascalCase
* Constants: UPPER_SNAKE_CASE

---

## üîå **API & Services Integration**

* **tRPC** for type‚Äësafe API calls
* **Convex** for realtime reads/mutations
* **Typesense** for search suggestions, typo tolerance
* **Razorpay** checkout integration
* **Leaflet + OpenStreetMap** for geolocation & distance computation

### Error Handling

* Retry logic
* Graceful UI feedback via toast notifications (`useToast().error()`)
* Network failure fallbacks
* Show error toasts for failed operations
* Show success toasts for completed operations

---

## üìç **Location & ETA System**

### üéØ **Overview**

MohallaMart uses a **Blinkit-style delivery ETA system** optimized for OpenStreetMap (OSM). The system calculates accurate, hyperlocal delivery times based on distance, store capacity, and peak hours.

### üì¶ **Core Utilities**

#### **Distance Calculation** (`src/lib/distance.ts`)

* **`haversineDistanceKm(lat1, lon1, lat2, lon2)`**: Pure math implementation using Haversine formula
* Returns distance in kilometers (rounded to 4 decimals)
* Works with Leaflet marker coordinates
* No external API calls required

#### **ETA Calculation** (`src/lib/eta.ts`)

* **`calculateEtaMinutes(input: EtaInput)`**: Blinkit-style ETA calculation
* **Formula**:
  1. Prep time = `basePrepMinutes + (excessOrders * 2)`
  2. Travel time = `(distanceKm / avgRiderSpeedKmph) * 60`
  3. Peak hour multiplier: `travelTime *= 1.25` (if peak hour)
  4. Final ETA = `prepTime + travelTime + bufferMinutes`
  5. Safe range: `minEta = max(5, round(rawEta - 5))`, `maxEta = round(rawEta + 5)`
* **Default Store Profile**:
  ```typescript
  {
    basePrepMinutes: 5,
    maxParallelOrders: 3,
    bufferMinutes: 5,
    avgRiderSpeedKmph: 20
  }
  ```

#### **Vendor Geographic Utilities** (`src/lib/vendor-geo.ts`)

* **`findNearbyVendors(vendors, userCoords, radiusKm = 2)`**: Find vendors within radius
* Filters vendors by distance using Haversine formula
* Returns vendors sorted by distance (closest first)
* Only includes vendors with valid coordinates

#### **Peak Hour Detection** (`src/lib/time.ts`)

* **`isPeakHour(now?: Date)`**: Detects peak delivery hours
* Peak hours: **7-10 AM** and **6-10 PM (18-22)**
* Returns `true` during peak hours, `false` otherwise

### üîå **API Endpoint**

#### **GET `/api/vendors/nearby`**

**Query Parameters:**
- `userLat` (required): User's latitude
- `userLon` (required): User's longitude
- `radiusKm` (optional): Search radius in km (default: 2)

**Response:**
```json
{
  "vendors": [
    {
      "id": "shop_id",
      "name": "Shop Name",
      "distanceKm": 1.23,
      "eta": {
        "minEta": 12,
        "maxEta": 22
      },
      "location": {
        "lat": 28.6139,
        "lon": 77.2090
      },
      "...otherShopFields": "..."
    }
  ],
  "count": 2,
  "userLocation": { "lat": 28.6129, "lon": 77.2080 },
  "radiusKm": 2,
  "peakHour": false
}
```

### üé® **UI Integration**

#### **ProductCard Component**

* Accepts optional `eta` prop: `{ minEta: number; maxEta: number }`
* Displays: `${eta.minEta}-${eta.maxEta} mins` if ETA provided
* Falls back to `"30 mins"` if ETA not available
* Blinkit-style delivery pill design

#### **MobileHeader Component**

* Automatically fetches ETA from `/api/vendors/nearby` when location coordinates are available
* Displays dynamic ETA: `"${minEta}-${maxEta} mins"` or `"20 mins"` fallback
* Auto-refreshes ETA every 2 minutes
* Shows loading state (`"..."`) while fetching

### üìã **Usage Examples**

#### **Calculate ETA Manually**

```typescript
import { calculateEtaMinutes, DEFAULT_STORE_PROFILE } from "@/lib/eta";
import { isPeakHour } from "@/lib/time";
import { haversineDistanceKm } from "@/lib/distance";

const distance = haversineDistanceKm(userLat, userLon, shopLat, shopLng);
const eta = calculateEtaMinutes({
  storeProfile: DEFAULT_STORE_PROFILE,
  distanceKm: distance,
  currentPendingOrders: 2,
  isPeakHour: isPeakHour(),
});
// Result: { rawEta: 15.5, minEta: 10, maxEta: 20 }
```

#### **Fetch Nearby Vendors with ETA**

```typescript
const response = await fetch(
  `/api/vendors/nearby?userLat=${lat}&userLon=${lng}&radiusKm=2`
);
const data = await response.json();
// data.vendors contains vendors with distance and ETA
```

#### **Use ETA in ProductCard**

```typescript
<ProductCard
  product={product}
  onAddToCart={handleAddToCart}
  eta={vendor.eta} // { minEta: 12, maxEta: 22 }
/>
```

### ‚ö†Ô∏è **Implementation Notes**

* **Store Delivery Profiles**: Currently uses default profile. TODO: Add per-store delivery profiles to shop schema
* **Pending Orders**: Uses `api.orders.getOrdersByShop` with `status: "pending"` filter
* **Caching**: Consider caching ETA calculations for performance (not yet implemented)
* **Real-time Updates**: ETA refreshes every 2 minutes in MobileHeader
* **Error Handling**: Gracefully falls back to default values if API fails

### üîß **Future Enhancements**

* Per-store delivery profile configuration
* Real-time order queue updates
* Rider availability tracking
* Traffic-aware ETA adjustments
* Historical delivery time analytics

---

## ‚öôÔ∏è **Background Jobs (Inngest)**

* 16+ automated job functions
* Email/SMS notifications
* Order lifecycle events
* Automatic retries with exponential backoff
* Debug logging in development

---

## üì± **Mobile Responsiveness**

* Tailwind responsive utilities
* Touch‚Äëfriendly UI
* Optimized image loading
* Tested on 320px ‚Üí 2560px

---

## üõ°Ô∏è **Security Best Practices**

* Environment variables for secrets
* Server‚Äëonly utilities for admin operations
* Input sanitization
* Token validation on all requests
* HTTPS in production

---

## üöÄ **Deployment & Performance**

* Optimized Next.js builds
* Proper caching strategies
* Image optimization with `<Image />`
* Metadata for SEO
* Chunk splitting + lazy loading

---

## üß© **Common Patterns**

* Custom hooks for logic reuse
* Compound components for complex UIs
* Loading skeletons (use Shadcn `Skeleton` component)
* Accessible dropdowns (use Shadcn `DropdownMenu` component)
* Geolocation via `navigator.geolocation`
* Haversine formula for shop distance filtering (use `haversineDistanceKm` from `@/lib/distance`)
* **Location & ETA System**: Use utilities from `@/lib/distance`, `@/lib/eta`, `@/lib/vendor-geo`, `@/lib/time` for delivery time calculations
* **Dynamic ETA Display**: Use `/api/vendors/nearby` endpoint to fetch nearby vendors with ETA, display in `ProductCard` and `MobileHeader`
* Route guards for protected pages (`ShopkeeperGuard`, etc.)
* **Toast notifications**: Always use `useToast()` hook for user feedback - `const { success, error, warning, info } = useToast();` (Never use `alert()` or `confirm()`)
* Always wrap protected routes with guard components, never return `null` from guards during loading
* **UI Components**: Always check `src/components/ui/` for Shadcn components before creating custom ones
* **Installation**: If a needed Shadcn component doesn't exist, run `npx shadcn@latest add [component-name] --yes` immediately
* **CRITICAL: Read globals.css FIRST** - Before making any UI changes, always read `src/app/globals.css` to understand available CSS variables and theme system
* **Dark/Light Theme**: Always implement both themes using `dark:` variant and CSS variables from `globals.css`
* **Background Colors**: Always use `bg-white dark:bg-black` for page and section backgrounds - never use gradients, gray backgrounds, or muted backgrounds. Cards should also use `bg-white dark:bg-black` with proper borders (`border-neutral-200 dark:border-neutral-800`)
* **Text Colors**: Always use theme-aware text colors (`text-black dark:text-white`) - never hardcode black text that works in both themes. Use colorful text colors when needed for emphasis or semantic meaning
* **Color Usage**: Never hardcode colors - use theme-aware utilities like `bg-white dark:bg-black`, `text-black dark:text-white`, `border-neutral-200 dark:border-neutral-800`
* **Admin Exception**: Admin pages (`/admin/*`) are exempt from dark theme requirements

---

## üèóÔ∏è **High-Level Architecture**

```
Frontend: Next.js + Shadcn + Tailwind + Zustand
Backend: Convex + tRPC
Database: Supabase + Redis
Search: Typesense
Payments: Razorpay
Maps: Leaflet + OpenStreetMap (Nominatim)
Notifications: OneSignal + Twilio
Storage: Convex File Storage
Jobs: Inngest
```

### üåà **Theme & Tokens (Updated)**

**Use semantic tokens instead of hardcoded colors.** The source of truth is `src/app/globals.css`.

- Surfaces: `bg-background`, `bg-card`, `bg-popover`
- Text: `text-foreground`, `text-muted-foreground`, `text-heading`, `text-body`, `text-caption`
- Borders/inputs: `border-border`, `border-t border-border`, `focus-visible:outline-ring`
- Brand: `bg-primary`, `text-primary-foreground`, `bg-secondary`, `text-secondary-foreground`
- Containers: `bg-container-primary`, `bg-container-secondary`, `bg-container-tertiary`
- Status: `bg-[var(--success-bg-light)] text-[var(--success-fg)]` etc.

#### Examples

```tsx
// Page wrapper
<div className="min-h-screen bg-background text-foreground">

// Section
<section className="py-20 bg-background">

// Card
<div className="bg-card border border-border p-8 rounded-xl">

// Secondary text
<p className="text-muted-foreground">Supporting copy...</p>

// Accessible focus
<button className="focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring">Click</button>
```

### üåó **Dark/Light Implementation (Updated)**

- Respect system preference with `@media (prefers-color-scheme: dark)`; override with `.dark` or `.light` classes.
- Use the theme API `applyTheme("dark" | "light" | "system")` when toggling in components.
- Never hardcode hex colors in components; rely on tokens.
- Smooth transitions are enabled globally.

### üé® **Background Policy (Updated)**

- Main pages and sections should use `bg-background` for consistency.
- Cards and popovers use `bg-card`, `bg-popover` with `border-border`.
- Banners/CTAs may use brand colors (`bg-primary`, `bg-secondary`) with proper contrast.
- Avoid arbitrary grays; use tokens to meet AA contrast.
